#!/usr/bin/env node
'use strict';
// This is a proof of concept. The code below is ugly, inefficient and has no tests.

const fs = require('fs');
const yargs = require('yargs');
const {CARGO_SERIALIZER, PARCEL_SERIALIZER} = require('../messages/serialization');
const {Parcel} = require('../messages');

const SERIALIZER_BY_TYPE = {
    cargo: CARGO_SERIALIZER,
    parcel: PARCEL_SERIALIZER,
};

async function main(argv) {
    const parcel = new Parcel(
        argv.recipient,
        fs.readFileSync(argv.senderCert),
        fs.readFileSync(process.stdin.fd),
    );

    process.stdout.write(await PARCEL_SERIALIZER.serialize(
        parcel,
        argv.recipientCert,
        argv.senderKey,
        argv.signHashAlgo,
    ));
}

const argv = yargs
    .option('type', {
        choices: Object.keys(SERIALIZER_BY_TYPE),
        demandOption: true,
        requiresArg: true,
        description: 'The type of message (parcel or cargo)'
    })
    .option('recipient', {
        demandOption: true,
        requiresArg: true,
        description: "The recipient's address",
    })
    .option('recipient-cert', {
        demandOption: true,
        requiresArg: true,
        description: "The recipient's X.509 certificate (chain), DER-encoded",
        normalize: true,
    })
    .option('sender-cert', {
        demandOption: true,
        requiresArg: true,
        description: "The sender's X.509 certificate (chain), PEM-encoded",
        normalize: true,
    })
    .option('sender-key', {
        demandOption: true,
        requiresArg: true,
        description: "The sender's X.509 key to sign the message (PEM-encoded)",
        normalize: true,
    })
    .option('sign-hash-algo', {
        requiresArg: true,
        default: 'sha256',
        description: 'The hashing algorithm to use in the signature',
    })
    .help()
    .argv;

(async () => await main(argv))();
