#!/usr/bin/env node
'use strict';
// This is a proof of concept. The code below is ugly, inefficient and has no tests.

const fs = require('fs');
const yargs = require('yargs');
const {CARGO_SERIALIZER, PARCEL_SERIALIZER} = require('../messages/serialization');

const SERIALIZER_BY_TYPE = {
    cargo: CARGO_SERIALIZER,
    parcel: PARCEL_SERIALIZER,
};

function configureCli(builder) {
    builder
        .option('type', {
            choices: Object.keys(SERIALIZER_BY_TYPE),
            demandOption: true,
            requiresArg: true,
            description: 'The type of message (parcel or cargo)'
        })
        .normalize('messagePath')
        .requiresArg('messagePath')
    ;
}

function main(argv) {
    const messageRef = (argv.messagePath === '-') ? fs.openSync('/dev/stdin', 'rs') : argv.messagePath;
    const messageRaw = fs.readFileSync(messageRef);
    const serializer = SERIALIZER_BY_TYPE[argv.type];
    console.log(serializer.deserialize(messageRaw));
}

yargs
    .command('$0 <messagePath>', 'Inspect message', configureCli, main)
    .help()
    .argv;
